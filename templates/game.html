{% extends 'base.html' %}

{% block title %}Play Aviator - Aviator Game{% endblock %}

{% block extra_css %}
<style>
    .game-container {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    /* Game Canvas Area */
    .game-canvas {
        background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
        border-radius: 15px;
        padding: 2rem;
        position: relative;
        min-height: 600px;
        border: 2px solid var(--border-color);
        overflow: hidden;
    }
    
    .multiplier-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 6rem;
        font-weight: bold;
        color: var(--primary-color);
        text-shadow: 0 0 30px rgba(255, 87, 34, 0.8);
        z-index: 10;
    }
    
    .multiplier-display.flying {
        animation: pulse 0.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    
    .plane-icon {
        position: absolute;
        font-size: 4rem;
        transform: rotate(-45deg);
        transition: all 0.1s linear;
        filter: drop-shadow(0 0 20px rgba(255, 87, 34, 0.8));
    }
    
    .game-status {
        position: absolute;
        top: 2rem;
        left: 2rem;
        background: rgba(0,0,0,0.7);
        padding: 1rem 2rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }
    
    .status-text {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .status-waiting {
        color: var(--warning-color);
    }
    
    .status-flying {
        color: var(--success-color);
    }
    
    .status-crashed {
        color: var(--danger-color);
    }
    
    /* Round History */
    .round-history {
        position: absolute;
        bottom: 2rem;
        left: 2rem;
        right: 2rem;
        background: rgba(0,0,0,0.7);
        padding: 1rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }
    
    .history-title {
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .history-items {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        padding: 0.5rem 0;
    }
    
    .history-item {
        min-width: 60px;
        padding: 0.5rem;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .history-item.low {
        background-color: var(--danger-color);
    }
    
    .history-item.medium {
        background-color: var(--warning-color);
    }
    
    .history-item.high {
        background-color: var(--success-color);
    }
    
    /* Sidebar */
    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    /* Betting Panel */
    .betting-panel {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        border: 2px solid var(--border-color);
    }
    
    .bet-controls {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .amount-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--dark-bg);
        border-radius: 10px;
        padding: 0.5rem;
    }
    
    .amount-btn {
        background-color: var(--hover-bg);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .amount-btn:hover {
        background-color: var(--border-color);
    }
    
    .amount-input {
        flex: 1;
        background: transparent;
        border: none;
        color: white;
        font-size: 1.5rem;
        text-align: center;
        font-weight: bold;
    }
    
    .amount-input:focus {
        outline: none;
    }
    
    .quick-amounts {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }
    
    .quick-amount {
        background-color: var(--dark-bg);
        border: 1px solid var(--border-color);
        padding: 0.5rem;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
    }
    
    .quick-amount:hover {
        background-color: var(--hover-bg);
        border-color: var(--primary-color);
    }
    
    .auto-cashout-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .auto-cashout-control input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .auto-cashout-input {
        flex: 1;
        padding: 0.5rem;
        background-color: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 5px;
        color: white;
    }
    
    .bet-button {
        width: 100%;
        padding: 1rem;
        border: none;
        border-radius: 10px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .bet-button.place-bet {
        background: linear-gradient(135deg, var(--success-color), #66bb6a);
        color: white;
    }
    
    .bet-button.cashout {
        background: linear-gradient(135deg, var(--warning-color), #ffb74d);
        color: white;
        animation: pulse-btn 1s infinite;
    }
    
    @keyframes pulse-btn {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .bet-button:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        animation: none;
    }
    
    .current-bet-info {
        background-color: var(--dark-bg);
        padding: 1rem;
        border-radius: 10px;
        margin-top: 1rem;
    }
    
    .bet-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    /* Active Bets */
    .active-bets {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        border: 2px solid var(--border-color);
        max-height: 300px;
        overflow-y: auto;
    }
    
    .active-bet-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem;
        background-color: var(--dark-bg);
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    
    .active-bet-user {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .active-bet-amount {
        color: var(--success-color);
        font-weight: bold;
    }
    
    .active-bet-cashout {
        color: var(--warning-color);
        font-weight: bold;
    }
    
    /* Chat Section */
    .chat-section {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        border: 2px solid var(--border-color);
        height: 400px;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
        padding-right: 0.5rem;
    }
    
    .chat-message {
        margin-bottom: 0.8rem;
        padding: 0.5rem;
        border-radius: 8px;
        background-color: var(--dark-bg);
    }
    
    .chat-user {
        color: var(--primary-color);
        font-weight: bold;
        margin-right: 0.5rem;
    }
    
    .chat-text {
        color: var(--text-primary);
    }
    
    .chat-input-container {
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-input {
        flex: 1;
        padding: 0.8rem;
        background-color: var(--dark-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: white;
    }
    
    .chat-send {
        padding: 0.8rem 1.5rem;
        background: linear-gradient(135deg, var(--primary-color), #ff7043);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    
    /* Rain Alert */
    .rain-alert {
        position: fixed;
        top: 100px;
        right: 20px;
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
        z-index: 9998;
        max-width: 300px;
        animation: slideIn 0.5s;
    }
    
    .rain-icon {
        font-size: 3rem;
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    .rain-title {
        font-size: 1.3rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    .rain-details {
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .rain-join-btn {
        width: 100%;
        padding: 0.8rem;
        background-color: white;
        color: #4caf50;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
        .game-container {
            grid-template-columns: 1fr;
        }
        
        .multiplier-display {
            font-size: 4rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <!-- Main Game Canvas -->
    <div class="game-canvas" id="gameCanvas">
        <!-- Game Status -->
        <div class="game-status">
            <div class="status-text" id="gameStatus">
                <span class="status-waiting">WAITING FOR NEXT ROUND...</span>
            </div>
            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;" id="roundNumber">
                Round #<span id="currentRound">1</span>
            </div>
        </div>
        
        <!-- Multiplier Display -->
        <div class="multiplier-display" id="multiplierDisplay">
            1.00x
        </div>
        
        <!-- Plane Icon -->
        <div class="plane-icon" id="planeIcon">‚úàÔ∏è</div>
        
        <!-- Round History -->
        <div class="round-history">
            <div class="history-title">Recent Rounds</div>
            <div class="history-items" id="historyItems">
                <!-- History items will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Betting Panel -->
        <div class="betting-panel">
            <h3 style="margin-bottom: 1rem;">Place Your Bet</h3>
            
            <div class="bet-controls">
                <!-- Bet Amount -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">
                        Bet Amount (KES)
                    </label>
                    <div class="amount-control">
                        <button class="amount-btn" onclick="decreaseAmount()">-</button>
                        <input type="number" id="betAmount" class="amount-input" value="50" min="10" max="50000">
                        <button class="amount-btn" onclick="increaseAmount()">+</button>
                    </div>
                </div>
                
                <!-- Quick Amounts -->
                <div class="quick-amounts">
                    <div class="quick-amount" onclick="setAmount(50)">50</div>
                    <div class="quick-amount" onclick="setAmount(100)">100</div>
                    <div class="quick-amount" onclick="setAmount(500)">500</div>
                    <div class="quick-amount" onclick="setAmount(1000)">1K</div>
                </div>
                
                <!-- Auto Cashout -->
                <div class="auto-cashout-control">
                    <input type="checkbox" id="autoCashoutEnabled">
                    <label for="autoCashoutEnabled">Auto Cashout at</label>
                    <input type="number" id="autoCashoutAmount" class="auto-cashout-input" 
                           value="2.00" min="1.01" step="0.01" disabled>
                    <span>x</span>
                </div>
                
                <!-- Bet Button -->
                <button class="bet-button place-bet" id="betButton" onclick="placeBet()">
                    PLACE BET
                </button>
                
                <!-- Current Bet Info -->
                <div class="current-bet-info" id="currentBetInfo" style="display: none;">
                    <div class="bet-info-row">
                        <span>Bet Amount:</span>
                        <span id="activeBetAmount" class="text-success">0 KES</span>
                    </div>
                    <div class="bet-info-row">
                        <span>Current Multiplier:</span>
                        <span id="activeBetMultiplier" class="text-warning">1.00x</span>
                    </div>
                    <div class="bet-info-row">
                        <span>Potential Win:</span>
                        <span id="activeBetPotential" class="text-success">0 KES</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Active Bets -->
        <div class="active-bets">
            <h4 style="margin-bottom: 1rem;">Active Bets</h4>
            <div id="activeBetsList">
                <!-- Active bets will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Chat Section (Full Width Below Game) -->
<div class="chat-section" style="margin-top: 1.5rem;">
    <h4 style="margin-bottom: 1rem;">Live Chat</h4>
    <div class="chat-messages" id="chatMessages">
        <!-- Chat messages will be populated here -->
    </div>
    <div class="chat-input-container">
        <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="500">
        <button class="chat-send" onclick="sendMessage()">Send</button>
    </div>
</div>

<!-- Rain Alert (Hidden by default) -->
<div id="rainAlert" class="rain-alert" style="display: none;">
    <div class="rain-icon">üåßÔ∏èüí∞</div>
    <div class="rain-title">RAIN IS ACTIVE!</div>
    <div class="rain-details">
        <div><span id="rainAmount">0</span> KES per user</div>
        <div><span id="rainParticipants">0</span>/<span id="rainMaxParticipants">10</span> joined</div>
    </div>
    <button class="rain-join-btn" onclick="joinRain()">JOIN RAIN</button>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Game State
    let gameState = {
        status: 'waiting', // waiting, flying, crashed
        currentMultiplier: 1.00,
        currentRound: null,
        activeBet: null,
        roundHistory: []
    };
    
    let updateInterval = null;
    let planePosition = { x: 20, y: 80 };
    
    // Auto-cashout checkbox handler
    document.getElementById('autoCashoutEnabled').addEventListener('change', function() {
        document.getElementById('autoCashoutAmount').disabled = !this.checked;
    });
    
    // Bet Amount Controls
    function decreaseAmount() {
        const input = document.getElementById('betAmount');
        let value = parseInt(input.value) || 50;
        input.value = Math.max(10, value - 10);
    }
    
    function increaseAmount() {
        const input = document.getElementById('betAmount');
        let value = parseInt(input.value) || 50;
        input.value = Math.min(50000, value + 10);
    }
    
    function setAmount(amount) {
        document.getElementById('betAmount').value = amount;
    }
    
    // Place Bet
    async function placeBet() {
        const amount = document.getElementById('betAmount').value;
        const autoCashoutEnabled = document.getElementById('autoCashoutEnabled').checked;
        const autoCashout = autoCashoutEnabled ? document.getElementById('autoCashoutAmount').value : null;
        
        if (amount < 10) {
            showToast('Minimum bet is 10 KES', 'error');
            return;
        }
        
        const result = await apiCall('{% url "aviator:api_place_bet" %}', 'POST', {
            amount: amount,
            auto_cashout: autoCashout
        });
        
        if (result.success) {
            gameState.activeBet = result.bet;
            showToast('Bet placed successfully!', 'success');
            updateBetButton();
            showCurrentBetInfo();
            await updateBalance();
        } else {
            showToast(result.message, 'error');
        }
    }
    
    // Cashout
    async function cashout() {
        if (!gameState.activeBet) return;
        
        const result = await apiCall('{% url "aviator:api_cashout" %}', 'POST', {
            bet_id: gameState.activeBet.id,
            multiplier: gameState.currentMultiplier
        });
        
        if (result.success) {
            showToast(`Cashed out at ${result.multiplier}x! Won ${result.payout} KES`, 'success');
            gameState.activeBet = null;
            updateBetButton();
            hideCurrentBetInfo();
            await updateBalance();
        } else {
            showToast(result.message, 'error');
        }
    }
    
    // Update bet button based on game state
    function updateBetButton() {
        const button = document.getElementById('betButton');
        
        if (gameState.activeBet && gameState.status === 'flying') {
            button.textContent = 'CASHOUT';
            button.className = 'bet-button cashout';
            button.onclick = cashout;
            button.disabled = false;
        } else if (gameState.status === 'waiting') {
            button.textContent = 'PLACE BET';
            button.className = 'bet-button place-bet';
            button.onclick = placeBet;
            button.disabled = gameState.activeBet !== null;
        } else {
            button.disabled = true;
        }
    }
    
    // Show/Hide current bet info
    function showCurrentBetInfo() {
        const info = document.getElementById('currentBetInfo');
        info.style.display = 'block';
        document.getElementById('activeBetAmount').textContent = 
            formatCurrency(gameState.activeBet.amount) + ' KES';
        updatePotentialWin();
    }
    
    function hideCurrentBetInfo() {
        document.getElementById('currentBetInfo').style.display = 'none';
    }
    
    function updatePotentialWin() {
        if (!gameState.activeBet) return;
        
        const potential = gameState.activeBet.amount * gameState.currentMultiplier;
        document.getElementById('activeBetMultiplier').textContent = gameState.currentMultiplier.toFixed(2) + 'x';
        document.getElementById('activeBetPotential').textContent = formatCurrency(potential) + ' KES';
    }
    
    // Fetch current round
    async function fetchCurrentRound() {
        const result = await apiCall('{% url "aviator:api_current_round" %}');
        
        if (result.success && result.round) {
            const round = result.round;
            gameState.currentRound = round;
            gameState.status = round.status;
            gameState.currentMultiplier = round.multiplier || 1.00;
            
            updateGameDisplay();
            updateActiveBetsList(round.bets);
            
            // Check auto-cashout
            if (gameState.activeBet && gameState.activeBet.auto_cashout && 
                gameState.currentMultiplier >= gameState.activeBet.auto_cashout) {
                await cashout();
            }
        }
    }
    
    // Update game display
    function updateGameDisplay() {
        const statusElement = document.getElementById('gameStatus');
        const multiplierElement = document.getElementById('multiplierDisplay');
        const planeElement = document.getElementById('planeIcon');
        const roundElement = document.getElementById('currentRound');
        
        if (gameState.currentRound) {
            roundElement.textContent = gameState.currentRound.round_number;
        }
        
        multiplierElement.textContent = gameState.currentMultiplier.toFixed(2) + 'x';
        
        if (gameState.status === 'waiting') {
            statusElement.innerHTML = '<span class="status-waiting">WAITING FOR NEXT ROUND...</span>';
            multiplierElement.classList.remove('flying');
            planePosition = { x: 20, y: 80 };
            planeElement.style.left = '20%';
            planeElement.style.top = '80%';
        } else if (gameState.status === 'flying') {
            statusElement.innerHTML = '<span class="status-flying">FLYING!</span>';
            multiplierElement.classList.add('flying');
            animatePlane();
        } else if (gameState.status === 'crashed') {
            statusElement.innerHTML = '<span class="status-crashed">FLEW AWAY!</span>';
            multiplierElement.classList.remove('flying');
        }
        
        updateBetButton();
        if (gameState.activeBet) {
            updatePotentialWin();
        }
    }
    
    // Animate plane
    function animatePlane() {
        const planeElement = document.getElementById('planeIcon');
        planePosition.x = Math.min(80, planePosition.x + 0.5);
        planePosition.y = Math.max(20, planePosition.y - 0.5);
        
        planeElement.style.left = planePosition.x + '%';
        planeElement.style.top = planePosition.y + '%';
    }
    
    // Fetch round history
    async function fetchRoundHistory() {
        const result = await apiCall('{% url "aviator:api_round_history" %}?limit=20');
        
        if (result.success) {
            gameState.roundHistory = result.history;
            displayRoundHistory();
        }
    }
    
    // Display round history
    function displayRoundHistory() {
        const container = document.getElementById('historyItems');
        container.innerHTML = '';
        
        gameState.roundHistory.forEach(round => {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            if (round.multiplier < 2) {
                item.classList.add('low');
            } else if (round.multiplier < 5) {
                item.classList.add('medium');
            } else {
                item.classList.add('high');
            }
            
            item.textContent = round.multiplier.toFixed(2) + 'x';
            container.appendChild(item);
        });
    }
    
    // Update active bets list
    function updateActiveBetsList(bets) {
        const container = document.getElementById('activeBetsList');
        container.innerHTML = '';
        
        if (!bets || bets.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">No active bets</div>';
            return;
        }
        
        bets.forEach(bet => {
            const item = document.createElement('div');
            item.className = 'active-bet-item';
            
            item.innerHTML = `
                <div>
                    <div class="active-bet-user">${bet.user__phone_number}</div>
                    <div class="active-bet-amount">${formatCurrency(bet.amount)} KES</div>
                </div>
                ${bet.cashout_multiplier ? 
                    `<div class="active-bet-cashout">${bet.cashout_multiplier}x</div>` : 
                    bet.auto_cashout ? 
                    `<div style="color: var(--text-secondary); font-size: 0.8rem;">Auto @ ${bet.auto_cashout}x</div>` : 
                    ''}
            `;
            
            container.appendChild(item);
        });
    }
    
    // Chat functions
    async function loadChatMessages() {
        const result = await apiCall('{% url "aviator:api_chat_messages" %}?limit=50');
        
        if (result.success) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            result.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                messageDiv.innerHTML = `
                    <span class="chat-user">${msg.user}:</span>
                    <span class="chat-text">${escapeHtml(msg.message)}</span>
                `;
                container.appendChild(messageDiv);
            });
            
            container.scrollTop = container.scrollHeight;
        }
    }
    
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        const result = await apiCall('{% url "aviator:api_send_message" %}', 'POST', {
            message: message
        });
        
        if (result.success) {
            input.value = '';
            await loadChatMessages();
        } else {
            showToast(result.message, 'error');
        }
    }
    
    // Enter key for chat
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Check for active rains
    async function checkActiveRains() {
        const result = await apiCall('{% url "aviator:api_active_rains" %}');
        
        if (result.success && result.rains.length > 0) {
            const rain = result.rains[0];
            if (!rain.has_joined && !rain.is_full) {
                showRainAlert(rain);
            }
        }
    }
    
    function showRainAlert(rain) {
        const alert = document.getElementById('rainAlert');
        document.getElementById('rainAmount').textContent = rain.amount_per_user;
        document.getElementById('rainParticipants').textContent = rain.participants_count;
        document.getElementById('rainMaxParticipants').textContent = rain.max_participants;
        alert.style.display = 'block';
        alert.dataset.rainId = rain.id;
    }
    
    async function joinRain() {
        const alert = document.getElementById('rainAlert');
        const rainId = alert.dataset.rainId;
        
        const result = await apiCall('{% url "aviator:api_join_rain" %}', 'POST', {
            rain_id: rainId
        });
        
        if (result.success) {
            showToast('Joined rain successfully!', 'success');
            alert.style.display = 'none';
            await updateBalance();
        } else {
            showToast(result.message, 'error');
        }
    }
    
    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize game
    async function initGame() {
        await fetchRoundHistory();
        await loadChatMessages();
        await checkActiveRains();
        
        // Start polling for game updates
        updateInterval = setInterval(async () => {
            await fetchCurrentRound();
        }, 100); // Update every 100ms for smooth animation
        
        // Slower updates for other data
        setInterval(loadChatMessages, 5000);
        setInterval(checkActiveRains, 10000);
    }
    
    // Start game when page loads
    window.addEventListener('load', initGame);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
</script>
{% endblock %}