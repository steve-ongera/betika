{% extends 'base.html' %}
{% load static %}
{% block title %}Play Aviator{% endblock %}

{% block extra_css %}
<style>
    .game-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    @media (min-width: 992px) {
        .game-container {
            grid-template-columns: 2.5fr 1fr;
        }
    }
    
    /* Game Canvas */
    .game-canvas {
        background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
        border-radius: 12px;
        padding: 1rem;
        position: relative;
        min-height: 400px;
        height: 60vh;
        border: 2px solid var(--border-color);
        overflow: hidden;
    }
    
    @media (min-width: 768px) {
        .game-canvas {
            min-height: 500px;
            padding: 1.5rem;
        }
    }
    
    @media (max-width: 576px) {
        .game-canvas {
            min-height: 350px;
            height: 50vh;
            padding: 0.75rem;
        }
    }
    
    .multiplier-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        font-weight: bold;
        color: var(--primary-color);
        text-shadow: 0 0 20px rgba(255, 87, 34, 0.8);
        z-index: 10;
        font-family: 'Courier New', monospace;
    }
    
    @media (min-width: 768px) {
        .multiplier-display {
            font-size: 5rem;
        }
    }
    
    @media (max-width: 576px) {
        .multiplier-display {
            font-size: 2.5rem;
        }
    }
    
    .multiplier-display.flying {
        animation: pulse 0.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    
    .plane-svg {
        position: absolute;
        width: 50px;
        height: 50px;
        transition: all 0.1s linear;
        filter: drop-shadow(0 0 15px rgba(255, 87, 34, 0.8));
        z-index: 15;
        will-change: transform, left, bottom;
    }
    
    @media (min-width: 768px) {
        .plane-svg {
            width: 60px;
            height: 60px;
        }
    }
    
    @media (max-width: 576px) {
        .plane-svg {
            width: 40px;
            height: 40px;
        }
    }
    
    .game-status {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: rgba(0,0,0,0.8);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
        font-size: 0.9rem;
        z-index: 20;
        border: 1px solid var(--border-color);
    }
    
    @media (min-width: 768px) {
        .game-status {
            padding: 1rem 1.5rem;
            font-size: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .game-status {
            top: 0.5rem;
            left: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
    }
    
    .status-text {
        font-weight: bold;
    }
    
    .status-waiting { color: var(--warning-color); }
    .status-flying { color: var(--success-color); }
    .status-crashed { color: var(--danger-color); }
    
    /* Round History - Super Compact and Tiny */
    .round-history {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(0,0,0,0.9);
        padding: 0.35rem;
        border-radius: 6px;
        backdrop-filter: blur(10px);
        z-index: 20;
        border: 1px solid var(--border-color);
        max-width: 110px;
        transition: all 0.3s ease;
    }
    
    @media (min-width: 768px) {
        .round-history {
            max-width: 130px;
            padding: 0.4rem;
        }
    }
    
    @media (max-width: 576px) {
        .round-history {
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.3rem;
            max-width: 95px;
        }
    }
    
    .round-history.expanded {
        max-width: 280px;
    }
    
    @media (max-width: 576px) {
        .round-history.expanded {
            max-width: calc(100% - 1rem);
            left: 0.5rem;
            right: 0.5rem;
        }
    }
    
    .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.3rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        user-select: none;
    }
    
    .history-header span {
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    @media (max-width: 576px) {
        .history-header span {
            font-size: 0.6rem;
        }
    }
    
    .history-toggle {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.75rem;
        padding: 0;
        transition: transform 0.3s ease;
    }
    
    .history-toggle.expanded {
        transform: rotate(180deg);
    }
    
    .history-items {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.25rem;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .round-history.expanded .history-items {
        max-height: 300px;
        overflow-y: auto;
        padding: 0.2rem 0;
    }
    
    @media (min-width: 768px) {
        .round-history.expanded .history-items {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    .history-items::-webkit-scrollbar {
        width: 3px;
    }
    
    .history-items::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 2px;
    }
    
    .history-preview {
        display: flex;
        gap: 0.25rem;
        flex-wrap: nowrap;
        overflow: hidden;
    }
    
    .round-history.expanded .history-preview {
        display: none;
    }
    
    .history-item {
        min-width: 28px;
        padding: 0.2rem 0.25rem;
        border-radius: 4px;
        text-align: center;
        font-weight: bold;
        font-size: 0.55rem;
        white-space: nowrap;
        flex-shrink: 0;
        line-height: 1.2;
    }
    
    @media (min-width: 768px) {
        .history-item {
            min-width: 32px;
            padding: 0.25rem 0.3rem;
            font-size: 0.6rem;
        }
    }
    
    .history-item.low { background-color: #d32f2f; color: white; }
    .history-item.medium { background-color: #f57c00; color: white; }
    .history-item.high { background-color: #388e3c; color: white; }
    
    /* Mobile Layout - Betting Panel Right After Game */
    @media (max-width: 991px) {
        .game-container {
            display: flex;
            flex-direction: column;
        }
        
        .game-canvas-wrapper {
            order: 1;
        }
        
        .betting-panel {
            order: 2;
        }
        
        .sidebar-extras {
            order: 3;
        }
    }
    
    /* Betting Panel */
    .betting-panel {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        border: 2px solid var(--border-color);
    }
    
    @media (max-width: 991px) {
        .betting-panel {
            margin-bottom: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .betting-panel {
            padding: 0.875rem;
        }
        
        .betting-panel h6 {
            font-size: 0.95rem;
        }
    }
    
    .amount-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--dark-bg);
        border-radius: 8px;
        padding: 0.5rem;
    }
    
    .amount-btn {
        background-color: var(--hover-bg);
        border: none;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        transition: background-color 0.2s ease;
    }
    
    .amount-btn:active {
        background-color: var(--primary-color);
    }
    
    .amount-input {
        flex: 1;
        background: transparent;
        border: none;
        color: white;
        font-size: 1.25rem;
        text-align: center;
        font-weight: bold;
    }
    
    .amount-input:focus {
        outline: none;
    }
    
    @media (max-width: 576px) {
        .amount-input {
            font-size: 1.1rem;
        }
        
        .amount-btn {
            padding: 0.4rem 0.65rem;
            font-size: 1.1rem;
        }
    }
    
    .quick-amounts {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.4rem;
    }
    
    .quick-amount {
        background-color: var(--dark-bg);
        border: 1px solid var(--border-color);
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .quick-amount:hover,
    .quick-amount:active {
        background-color: var(--hover-bg);
        border-color: var(--primary-color);
        transform: scale(0.98);
    }
    
    @media (max-width: 576px) {
        .quick-amount {
            padding: 0.45rem;
            font-size: 0.8rem;
        }
    }
    
    .bet-button {
        width: 100%;
        padding: 0.9rem;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    @media (max-width: 576px) {
        .bet-button {
            padding: 0.8rem;
            font-size: 1rem;
        }
    }
    
    .bet-button.place-bet {
        background: linear-gradient(135deg, var(--success-color), #66bb6a);
        color: white;
    }
    
    .bet-button.place-bet:active {
        transform: scale(0.98);
    }
    
    .bet-button.cashout {
        background: linear-gradient(135deg, var(--warning-color), #ffb74d);
        color: white;
        animation: pulse-btn 1s infinite;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
    }
    
    .cashout-amount {
        font-size: 1.3rem;
        font-weight: 900;
        color: #fff;
    }
    
    @media (max-width: 576px) {
        .cashout-amount {
            font-size: 1.1rem;
        }
    }
    
    @keyframes pulse-btn {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .bet-button:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        animation: none;
        opacity: 0.6;
    }
    
    /* Active Bets */
    .active-bets {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        max-height: 300px;
        overflow-y: auto;
    }
    
    @media (max-width: 991px) {
        .active-bets {
            max-height: 250px;
        }
    }
    
    @media (max-width: 576px) {
        .active-bets {
            padding: 0.875rem;
            max-height: 220px;
        }
        
        .active-bets h6 {
            font-size: 0.95rem;
        }
    }
    
    .active-bet-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem;
        background-color: var(--dark-bg);
        border-radius: 6px;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
    }
    
    @media (max-width: 576px) {
        .active-bet-item {
            padding: 0.5rem;
            font-size: 0.8rem;
        }
    }
    
    /* Chat Section */
    .chat-section {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        height: 350px;
        display: flex;
        flex-direction: column;
    }
    
    @media (min-width: 768px) and (max-width: 991px) {
        .chat-section {
            height: 300px;
        }
    }
    
    @media (max-width: 576px) {
        .chat-section {
            height: 280px;
            padding: 0.875rem;
        }
        
        .chat-section h6 {
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 0.75rem;
        padding-right: 0.5rem;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 4px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 2px;
    }
    
    .chat-message {
        margin-bottom: 0.6rem;
        padding: 0.5rem;
        border-radius: 6px;
        background-color: var(--dark-bg);
        font-size: 0.85rem;
        line-height: 1.4;
    }
    
    @media (max-width: 576px) {
        .chat-message {
            padding: 0.45rem;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
    }
    
    .chat-user {
        color: var(--primary-color);
        font-weight: bold;
        margin-right: 0.5rem;
    }
    
    /* Rain Alert */
    .rain-alert {
        position: fixed;
        top: calc(var(--header-height) + 20px);
        right: 15px;
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
        z-index: 9998;
        max-width: 280px;
        animation: slideIn 0.5s;
    }
    
    @media (max-width: 576px) {
        .rain-alert {
            top: calc(var(--header-height) + 10px);
            right: 10px;
            left: 10px;
            max-width: none;
            padding: 0.875rem;
        }
    }
    
    .rain-icon {
        font-size: 2.5rem;
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    @media (max-width: 576px) {
        .rain-icon {
            font-size: 2rem;
        }
    }
    
    /* Current Bet Info */
    #currentBetInfo {
        margin-top: 1rem;
        padding: 0.75rem;
        background: var(--dark-bg);
        border-radius: 8px;
        font-size: 0.85rem;
        border: 1px solid var(--border-color);
    }
    
    @media (max-width: 576px) {
        #currentBetInfo {
            padding: 0.65rem;
            font-size: 0.8rem;
        }
    }
    
    /* Auto Cashout */
    .form-check-label {
        font-size: 0.9rem;
    }
    
    @media (max-width: 576px) {
        .form-check-label {
            font-size: 0.85rem;
        }
        
        #autoCashoutAmount {
            width: 65px !important;
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="game-container">
        <!-- Main Game Canvas -->
        <div class="game-canvas-wrapper">
            <div class="game-canvas" id="gameCanvas">
                <!-- Game Status -->
                <div class="game-status">
                    <div class="status-text" id="gameStatus">
                        <span class="status-waiting">WAITING...</span>
                    </div>
                    <small class="text-secondary">Round #<span id="currentRound">1</span></small>
                </div>
                
                <!-- Round History (Top Right) - Compact with Dropdown -->
                <div class="round-history" id="roundHistory">
                    <div class="history-header" onclick="toggleHistory()">
                        <span>History</span>
                        <button class="history-toggle" id="historyToggle">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>
                    <div class="history-preview" id="historyPreview">
                        <!-- Last 5 in preview -->
                    </div>
                    <div class="history-items" id="historyItems">
                        <!-- All 15 when expanded -->
                    </div>
                </div>
                
                <!-- Multiplier Display -->
                <div class="multiplier-display" id="multiplierDisplay">1.00x</div>
                
                <!-- Plane SVG -->
                <img src="{% static 'images/plane.svg' %}" class="plane-svg" id="planeIcon" alt="Plane">
            </div>
            
            <!-- Betting Panel (Below Game on Mobile) -->
            <div class="betting-panel mt-3 d-lg-none">
                <h6 class="mb-3">
                    <i class="bi bi-coin"></i> Place Bet
                </h6>
                
                <!-- Bet Amount -->
                <label class="form-label small text-secondary">Amount (KES)</label>
                <div class="amount-control mb-2">
                    <button class="amount-btn" onclick="decreaseAmount()">-</button>
                    <input type="number" id="betAmount" class="amount-input" value="50" min="10" max="50000">
                    <button class="amount-btn" onclick="increaseAmount()">+</button>
                </div>
                
                <!-- Quick Amounts -->
                <div class="quick-amounts mb-3">
                    <div class="quick-amount" onclick="setAmount(50)">50</div>
                    <div class="quick-amount" onclick="setAmount(100)">100</div>
                    <div class="quick-amount" onclick="setAmount(500)">500</div>
                    <div class="quick-amount" onclick="setAmount(1000)">1K</div>
                </div>
                
                <!-- Auto Cashout -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="autoCashoutEnabled">
                    <label class="form-check-label small" for="autoCashoutEnabled">
                        Auto cashout at
                        <input type="number" id="autoCashoutAmount" class="form-control form-control-sm d-inline-block" 
                               style="width: 70px;" value="2.00" min="1.01" step="0.01" disabled>x
                    </label>
                </div>
                
                <!-- Bet Button -->
                <button class="bet-button place-bet" id="betButton" onclick="placeBet()">
                    <i class="bi bi-check-circle-fill"></i> PLACE BET
                </button>
                
                <!-- Current Bet Info -->
                <div id="currentBetInfo" style="display: none;">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Bet:</span>
                        <span id="activeBetAmount" class="text-success fw-bold">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Multiplier:</span>
                        <span id="activeBetMultiplier" class="text-warning fw-bold">1.00x</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Win:</span>
                        <span id="activeBetPotential" class="text-success fw-bold">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Chat Section (Below Betting on Mobile) -->
            <div class="chat-section mt-3 d-lg-none">
                <h6 class="mb-2">
                    <i class="bi bi-chat-dots-fill"></i> Live Chat
                </h6>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="input-group input-group-sm">
                    <input type="text" id="chatInput" class="form-control form-control-sm" 
                           placeholder="Message..." maxlength="500">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar (Desktop Only) -->
        <div class="sidebar-extras d-none d-lg-block">
            <!-- Betting Panel -->
            <div class="betting-panel mb-3">
                <h6 class="mb-3">
                    <i class="bi bi-coin"></i> Place Bet
                </h6>
                
                <!-- Bet Amount -->
                <label class="form-label small text-secondary">Amount (KES)</label>
                <div class="amount-control mb-2">
                    <button class="amount-btn" onclick="decreaseAmount()">-</button>
                    <input type="number" id="betAmountDesktop" class="amount-input" value="50" min="10" max="50000">
                    <button class="amount-btn" onclick="increaseAmount()">+</button>
                </div>
                
                <!-- Quick Amounts -->
                <div class="quick-amounts mb-3">
                    <div class="quick-amount" onclick="setAmount(50)">50</div>
                    <div class="quick-amount" onclick="setAmount(100)">100</div>
                    <div class="quick-amount" onclick="setAmount(500)">500</div>
                    <div class="quick-amount" onclick="setAmount(1000)">1K</div>
                </div>
                
                <!-- Auto Cashout -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="autoCashoutEnabledDesktop">
                    <label class="form-check-label small" for="autoCashoutEnabledDesktop">
                        Auto cashout at
                        <input type="number" id="autoCashoutAmountDesktop" class="form-control form-control-sm d-inline-block" 
                               style="width: 70px;" value="2.00" min="1.01" step="0.01" disabled>x
                    </label>
                </div>
                
                <!-- Bet Button -->
                <button class="bet-button place-bet" id="betButtonDesktop" onclick="placeBet()">
                    <i class="bi bi-check-circle-fill"></i> PLACE BET
                </button>
                
                <!-- Current Bet Info -->
                <div id="currentBetInfoDesktop" style="display: none;">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Bet:</span>
                        <span id="activeBetAmountDesktop" class="text-success fw-bold">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Multiplier:</span>
                        <span id="activeBetMultiplierDesktop" class="text-warning fw-bold">1.00x</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Win:</span>
                        <span id="activeBetPotentialDesktop" class="text-success fw-bold">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Active Bets -->
            <div class="active-bets mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-people-fill"></i> Active Bets
                </h6>
                <div id="activeBetsList"></div>
            </div>
            
            <!-- Chat Section -->
            <div class="chat-section">
                <h6 class="mb-2">
                    <i class="bi bi-chat-dots-fill"></i> Live Chat
                </h6>
                <div class="chat-messages" id="chatMessagesDesktop"></div>
                <div class="input-group input-group-sm">
                    <input type="text" id="chatInputDesktop" class="form-control form-control-sm" 
                           placeholder="Message..." maxlength="500">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rain Alert -->
<div id="rainAlert" class="rain-alert" style="display: none;">
    <div class="rain-icon">üåßÔ∏èüí∞</div>
    <div class="text-center fw-bold mb-2">RAIN ACTIVE!</div>
    <div class="text-center small mb-2">
        <div><span id="rainAmount">0</span> KES per user</div>
        <div><span id="rainParticipants">0</span>/<span id="rainMaxParticipants">10</span> joined</div>
    </div>
    <button class="btn btn-light btn-sm w-100 fw-bold" onclick="joinRain()">JOIN NOW</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
        // Game State
        let gameState = {
            status: 'waiting',
            currentMultiplier: 1.00,
            currentRound: null,
            activeBet: null,
            roundHistory: [],
            lastRoundId: null,
            isCashingOut: false
        };
        
        let updateInterval = null;
        let planePosition = { x: 5, y: 5, angle: 0 };
        
        // History Toggle
        window.toggleHistory = function() {
            const roundHistory = document.getElementById('roundHistory');
            const toggle = document.getElementById('historyToggle');
            const icon = toggle.querySelector('i');
            
            roundHistory.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
            
            if (roundHistory.classList.contains('expanded')) {
                icon.className = 'bi bi-chevron-up';
            } else {
                icon.className = 'bi bi-chevron-down';
            }
        };
        
        // Sync desktop and mobile auto-cashout checkboxes
        document.getElementById('autoCashoutEnabled')?.addEventListener('change', function() {
            document.getElementById('autoCashoutAmount').disabled = !this.checked;
            const desktopCheckbox = document.getElementById('autoCashoutEnabledDesktop');
            if (desktopCheckbox) {
                desktopCheckbox.checked = this.checked;
                document.getElementById('autoCashoutAmountDesktop').disabled = !this.checked;
            }
        });
        
        document.getElementById('autoCashoutEnabledDesktop')?.addEventListener('change', function() {
            document.getElementById('autoCashoutAmountDesktop').disabled = !this.checked;
            const mobileCheckbox = document.getElementById('autoCashoutEnabled');
            if (mobileCheckbox) {
                mobileCheckbox.checked = this.checked;
                document.getElementById('autoCashoutAmount').disabled = !this.checked;
            }
        });
        
        // Bet Amount Controls
        window.decreaseAmount = function() {
            const mobileInput = document.getElementById('betAmount');
            const desktopInput = document.getElementById('betAmountDesktop');
            let value = parseInt(mobileInput?.value || desktopInput?.value || 50);
            const newValue = Math.max(10, value - 10);
            if (mobileInput) mobileInput.value = newValue;
            if (desktopInput) desktopInput.value = newValue;
        };
        
        window.increaseAmount = function() {
            const mobileInput = document.getElementById('betAmount');
            const desktopInput = document.getElementById('betAmountDesktop');
            let value = parseInt(mobileInput?.value || desktopInput?.value || 50);
            const newValue = Math.min(50000, value + 10);
            if (mobileInput) mobileInput.value = newValue;
            if (desktopInput) desktopInput.value = newValue;
        };
        
        window.setAmount = function(amount) {
            const mobileInput = document.getElementById('betAmount');
            const desktopInput = document.getElementById('betAmountDesktop');
            if (mobileInput) mobileInput.value = amount;
            if (desktopInput) desktopInput.value = amount;
        };
        
        // Place Bet
        window.placeBet = async function() {
            // Don't allow betting if already have active bet
            if (gameState.activeBet) {
                showToast('You already have an active bet', 'warning');
                return;
            }
            
            const mobileInput = document.getElementById('betAmount');
            const desktopInput = document.getElementById('betAmountDesktop');
            const amount = mobileInput?.value || desktopInput?.value;
            
            const mobileAutoCheckbox = document.getElementById('autoCashoutEnabled');
            const desktopAutoCheckbox = document.getElementById('autoCashoutEnabledDesktop');
            const autoCashoutEnabled = mobileAutoCheckbox?.checked || desktopAutoCheckbox?.checked;
            
            const mobileAutoAmount = document.getElementById('autoCashoutAmount');
            const desktopAutoAmount = document.getElementById('autoCashoutAmountDesktop');
            const autoCashout = autoCashoutEnabled ? (mobileAutoAmount?.value || desktopAutoAmount?.value) : null;
            
            if (amount < 10) {
                showToast('Minimum bet is 10 KES', 'error');
                return;
            }
            
            const result = await apiCall('{% url "aviator:api_place_bet" %}', 'POST', {
                amount: amount,
                auto_cashout: autoCashout
            });
            
            if (result.success) {
                gameState.activeBet = result.bet;
                showToast('Bet placed successfully!', 'success');
                updateBetButton();
                showCurrentBetInfo();
                await updateBalance();
            } else {
                showToast(result.message, 'error');
            }
        };
        
        // Cashout - INSTANT AND SMOOTH
        window.cashout = async function() {
            if (!gameState.activeBet || gameState.isCashingOut) return;
            
            // Prevent double cashout
            gameState.isCashingOut = true;
            
            // Disable button immediately for instant feedback
            const buttons = [document.getElementById('betButton'), document.getElementById('betButtonDesktop')];
            buttons.forEach(button => {
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i> CASHING OUT...';
                }
            });
            
            try {
                const result = await apiCall('{% url "aviator:api_cashout" %}', 'POST', {
                    bet_id: gameState.activeBet.id,
                    multiplier: gameState.currentMultiplier
                });
                
                if (result.success) {
                    showToast(`üéâ Cashed out ${result.multiplier}x! Won ${formatCurrency(result.payout)} KES`, 'success');
                    
                    // Clear active bet immediately
                    gameState.activeBet = null;
                    gameState.isCashingOut = false;
                    
                    // Update UI instantly
                    hideCurrentBetInfo();
                    updateBetButton();
                    await updateBalance();
                    
                    // Reset to default amount for next bet
                    resetBetAmount();
                } else {
                    showToast(result.message, 'error');
                    gameState.isCashingOut = false;
                    updateBetButton();
                }
            } catch (error) {
                showToast('Cashout failed. Please try again.', 'error');
                gameState.isCashingOut = false;
                updateBetButton();
            }
        };
        
        // Reset bet amount to default
        function resetBetAmount() {
            const defaultAmount = 50;
            const mobileInput = document.getElementById('betAmount');
            const desktopInput = document.getElementById('betAmountDesktop');
            if (mobileInput) mobileInput.value = defaultAmount;
            if (desktopInput) desktopInput.value = defaultAmount;
        }
        
        function updateBetButton() {
            const buttons = [document.getElementById('betButton'), document.getElementById('betButtonDesktop')];
            
            buttons.forEach(button => {
                if (!button) return;
                
                // If cashing out, keep disabled
                if (gameState.isCashingOut) {
                    button.disabled = true;
                    button.innerHTML = '<i class="bi bi-hourglass-split"></i> CASHING OUT...';
                    return;
                }
                
                if (gameState.activeBet && gameState.status === 'flying') {
                    // Show cashout button with amount
                    const potentialWin = (gameState.activeBet.amount * gameState.currentMultiplier).toFixed(2);
                    button.innerHTML = `
                        <div><i class="bi bi-cash-stack"></i> CASHOUT</div>
                        <div class="cashout-amount">${formatCurrency(potentialWin)} KES</div>
                    `;
                    button.className = 'bet-button cashout';
                    button.onclick = cashout;
                    button.disabled = false;
                } else if (gameState.status === 'waiting') {
                    // Show place bet button
                    button.innerHTML = '<i class="bi bi-check-circle-fill"></i> PLACE BET';
                    button.className = 'bet-button place-bet';
                    button.onclick = placeBet;
                    button.disabled = gameState.activeBet !== null;
                } else {
                    // Crashed or other status
                    button.disabled = true;
                    if (gameState.status === 'crashed') {
                        button.innerHTML = '<i class="bi bi-x-circle"></i> ROUND ENDED';
                        button.className = 'bet-button';
                    }
                }
            });
        }
        
        function showCurrentBetInfo() {
            const infos = [
                { container: 'currentBetInfo', amount: 'activeBetAmount', mult: 'activeBetMultiplier', potential: 'activeBetPotential' },
                { container: 'currentBetInfoDesktop', amount: 'activeBetAmountDesktop', mult: 'activeBetMultiplierDesktop', potential: 'activeBetPotentialDesktop' }
            ];
            
            infos.forEach(info => {
                const container = document.getElementById(info.container);
                if (container) {
                    container.style.display = 'block';
                    const amountEl = document.getElementById(info.amount);
                    if (amountEl) amountEl.textContent = formatCurrency(gameState.activeBet.amount) + ' KES';
                }
            });
            updatePotentialWin();
        }
        
        function hideCurrentBetInfo() {
            const containers = ['currentBetInfo', 'currentBetInfoDesktop'];
            containers.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }
        
        function updatePotentialWin() {
            if (!gameState.activeBet) return;
            const potential = gameState.activeBet.amount * gameState.currentMultiplier;
            
            const updates = [
                { mult: 'activeBetMultiplier', potential: 'activeBetPotential' },
                { mult: 'activeBetMultiplierDesktop', potential: 'activeBetPotentialDesktop' }
            ];
            
            updates.forEach(update => {
                const multEl = document.getElementById(update.mult);
                const potentialEl = document.getElementById(update.potential);
                if (multEl) multEl.textContent = gameState.currentMultiplier.toFixed(2) + 'x';
                if (potentialEl) potentialEl.textContent = formatCurrency(potential) + ' KES';
            });
        }
        
        // Fetch current round with real-time updates
        async function fetchCurrentRound() {
            const result = await apiCall('{% url "aviator:api_current_round" %}');
            
            if (result.success && result.round) {
                const round = result.round;
                const previousStatus = gameState.status;
                const previousRoundId = gameState.lastRoundId;
                
                gameState.currentRound = round;
                gameState.status = round.status;
                gameState.currentMultiplier = round.multiplier || 1.00;
                gameState.lastRoundId = round.id;
                
                // Detect new round starting
                if (previousRoundId && previousRoundId !== round.id && round.status === 'waiting') {
                    // New round started - clear lost bet if exists
                    if (gameState.activeBet) {
                        showToast('‚ùå Bet lost. Place a new bet!', 'warning');
                        gameState.activeBet = null;
                        hideCurrentBetInfo();
                        resetBetAmount();
                    }
                    
                    // Refresh history
                    await fetchRoundHistory();
                }
                
                // Detect round crash
                if (previousStatus === 'flying' && round.status === 'crashed') {
                    if (gameState.activeBet && !gameState.isCashingOut) {
                        // User didn't cash out in time
                        showToast('üí• Plane flew away! Bet lost.', 'error');
                        gameState.activeBet = null;
                        hideCurrentBetInfo();
                        resetBetAmount();
                    }
                }
                
                updateGameDisplay();
                updateActiveBetsList(round.bets);
                
                // Auto cashout check
                if (gameState.activeBet && gameState.activeBet.auto_cashout && 
                    gameState.currentMultiplier >= gameState.activeBet.auto_cashout &&
                    !gameState.isCashingOut && gameState.status === 'flying') {
                    await cashout();
                }
            }
        }
        
        function updateGameDisplay() {
            const statusElement = document.getElementById('gameStatus');
            const multiplierElement = document.getElementById('multiplierDisplay');
            const roundElement = document.getElementById('currentRound');
            
            if (gameState.currentRound) {
                roundElement.textContent = gameState.currentRound.round_number;
            }
            
            multiplierElement.textContent = gameState.currentMultiplier.toFixed(2) + 'x';
            
            if (gameState.status === 'waiting') {
                statusElement.innerHTML = '<span class="status-waiting">WAITING...</span>';
                multiplierElement.classList.remove('flying');
                resetPlane();
            } else if (gameState.status === 'flying') {
                statusElement.innerHTML = '<span class="status-flying">FLYING!</span>';
                multiplierElement.classList.add('flying');
                animatePlane();
            } else if (gameState.status === 'crashed') {
                statusElement.innerHTML = '<span class="status-crashed">FLEW AWAY!</span>';
                multiplierElement.classList.remove('flying');
            }
            
            updateBetButton();
            if (gameState.activeBet) updatePotentialWin();
        }
        
        function resetPlane() {
            planePosition = { x: 5, y: 5, angle: 0 };
            const planeElement = document.getElementById('planeIcon');
            planeElement.style.left = '5%';
            planeElement.style.bottom = '5%';
            planeElement.style.transform = 'rotate(0deg)';
        }
        
        function animatePlane() {
            const planeElement = document.getElementById('planeIcon');
            const mult = gameState.currentMultiplier;
            
            // Limit plane movement to reasonable multiplier range
            // Plane reaches max position at 10x, stays there for higher multipliers
            const maxMultiplier = 10.0;
            const cappedMult = Math.min(mult, maxMultiplier);
            const progress = Math.min((cappedMult - 1.0) / (maxMultiplier - 1.0), 1.0);
            
            // Smooth easing function
            const easeProgress = progress < 0.5 
                ? 2 * progress * progress 
                : 1 - Math.pow(-2 * progress + 2, 2) / 2;
            
            // Diagonal path: bottom-left to upper-right, but not to edges
            const startX = 5;
            const endX = 65;  // Stop at 65% to avoid right edge
            const startY = 5;
            const endY = 55;  // Stop at 55% to avoid top edge
            
            const x = startX + (endX - startX) * easeProgress;
            const y = startY + (endY - startY) * easeProgress;
            
            // Plane angle: gentle upward tilt (35-45 degrees)
            const angle = 35 + (progress * 10);
            
            planePosition = { x, y, angle };
            
            planeElement.style.left = x + '%';
            planeElement.style.bottom = y + '%';
            planeElement.style.transform = `rotate(${angle}deg)`;
        }
        
        // Fetch round history
        async function fetchRoundHistory() {
            const result = await apiCall('{% url "aviator:api_round_history" %}?limit=15');
            if (result.success) {
                gameState.roundHistory = result.history;
                displayRoundHistory();
            }
        }
        
        function displayRoundHistory() {
            const previewContainer = document.getElementById('historyPreview');
            const fullContainer = document.getElementById('historyItems');
            
            previewContainer.innerHTML = '';
            fullContainer.innerHTML = '';
            
            // Show last 5 in preview
            gameState.roundHistory.slice(0, 5).forEach(round => {
                const item = createHistoryItem(round);
                previewContainer.appendChild(item.cloneNode(true));
            });
            
            // Show all 15 in expanded view
            gameState.roundHistory.forEach(round => {
                const item = createHistoryItem(round);
                fullContainer.appendChild(item);
            });
        }
        
        function createHistoryItem(round) {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            if (round.multiplier < 2) item.classList.add('low');
            else if (round.multiplier < 5) item.classList.add('medium');
            else item.classList.add('high');
            
            item.textContent = round.multiplier.toFixed(2) + 'x';
            return item;
        }
        
        function updateActiveBetsList(bets) {
            const container = document.getElementById('activeBetsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!bets || bets.length === 0) {
                container.innerHTML = '<small class="text-secondary">No active bets</small>';
                return;
            }
            
            bets.slice(0, 10).forEach(bet => {
                const item = document.createElement('div');
                item.className = 'active-bet-item';
                item.innerHTML = `
                    <div>
                        <div class="text-secondary small">${bet.user__phone_number}</div>
                        <div class="text-success fw-bold">${formatCurrency(bet.amount)}</div>
                    </div>
                    ${bet.cashout_multiplier ? 
                        `<div class="text-warning fw-bold">${bet.cashout_multiplier}x</div>` : ''}
                `;
                container.appendChild(item);
            });
        }
        
        // Chat functions
        async function loadChatMessages() {
            const result = await apiCall('{% url "aviator:api_chat_messages" %}?limit=30');
            if (result.success) {
                const containers = ['chatMessages', 'chatMessagesDesktop'];
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    
                    container.innerHTML = '';
                    result.messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'chat-message';
                        div.innerHTML = `<span class="chat-user">${msg.user}:</span>${escapeHtml(msg.message)}`;
                        container.appendChild(div);
                    });
                    container.scrollTop = container.scrollHeight;
                });
            }
        }
        
        window.sendMessage = async function() {
            const mobileInput = document.getElementById('chatInput');
            const desktopInput = document.getElementById('chatInputDesktop');
            const input = mobileInput || desktopInput;
            const message = input?.value.trim();
            if (!message) return;
            
            const result = await apiCall('{% url "aviator:api_send_message" %}', 'POST', { message });
            if (result.success) {
                if (mobileInput) mobileInput.value = '';
                if (desktopInput) desktopInput.value = '';
                await loadChatMessages();
            } else {
                showToast(result.message, 'error');
            }
        };
        
        // Enter key for chat
        ['chatInput', 'chatInputDesktop'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendMessage();
                });
            }
        });
        
        // Check rains
        async function checkActiveRains() {
            const result = await apiCall('{% url "aviator:api_active_rains" %}');
            if (result.success && result.rains.length > 0) {
                const rain = result.rains[0];
                if (!rain.has_joined && !rain.is_full) showRainAlert(rain);
            }
        }
        
        function showRainAlert(rain) {
            const alert = document.getElementById('rainAlert');
            document.getElementById('rainAmount').textContent = rain.amount_per_user;
            document.getElementById('rainParticipants').textContent = rain.participants_count;
            document.getElementById('rainMaxParticipants').textContent = rain.max_participants;
            alert.style.display = 'block';
            alert.dataset.rainId = rain.id;
        }
        
        window.joinRain = async function() {
            const alert = document.getElementById('rainAlert');
            const result = await apiCall('{% url "aviator:api_join_rain" %}', 'POST', {
                rain_id: alert.dataset.rainId
            });
            if (result.success) {
                showToast('Joined rain!', 'success');
                alert.style.display = 'none';
                await updateBalance();
            } else {
                showToast(result.message, 'error');
            }
        };
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize
        async function initGame() {
            await fetchRoundHistory();
            await loadChatMessages();
            await checkActiveRains();
            
            // Fast updates for real-time odds (10 times per second)
            updateInterval = setInterval(fetchCurrentRound, 100);
            
            // Update history every 3 seconds
            setInterval(fetchRoundHistory, 3000);
            
            // Chat and rain checks
            setInterval(loadChatMessages, 5000);
            setInterval(checkActiveRains, 10000);
        }
        
        // Start
        initGame();
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
        });
    });
</script>
{% endblock %}