{% extends 'base.html' %}
{% load static %}
{% block title %}Play Aviator{% endblock %}

{% block extra_css %}
<style>
    .game-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    @media (min-width: 992px) {
        .game-container {
            grid-template-columns: 2.5fr 1fr;
        }
    }
    
    /* Game Canvas */
    .game-canvas {
        background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
        border-radius: 12px;
        padding: 1rem;
        position: relative;
        min-height: 400px;
        height: 60vh;
        border: 2px solid var(--border-color);
        overflow: hidden;
    }
    
    @media (min-width: 768px) {
        .game-canvas {
            min-height: 500px;
            padding: 1.5rem;
        }
    }
    
    .multiplier-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        font-weight: bold;
        color: var(--primary-color);
        text-shadow: 0 0 20px rgba(255, 87, 34, 0.8);
        z-index: 10;
        font-family: 'Courier New', monospace;
    }
    
    @media (min-width: 768px) {
        .multiplier-display {
            font-size: 5rem;
        }
    }
    
    .multiplier-display.flying {
        animation: pulse 0.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    
    .plane-svg {
        position: absolute;
        width: 40px;
        height: 40px;
        transition: all 0.1s linear;
        filter: drop-shadow(0 0 15px rgba(255, 87, 34, 0.8));
        z-index: 15;
    }
    
    @media (min-width: 768px) {
        .plane-svg {
            width: 60px;
            height: 60px;
        }
    }
    
    .game-status {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: rgba(0,0,0,0.7);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
        font-size: 0.9rem;
    }
    
    @media (min-width: 768px) {
        .game-status {
            padding: 1rem 1.5rem;
            font-size: 1rem;
        }
    }
    
    .status-text {
        font-weight: bold;
    }
    
    .status-waiting { color: var(--warning-color); }
    .status-flying { color: var(--success-color); }
    .status-crashed { color: var(--danger-color); }
    
    /* Round History - Like Betika */
    .round-history {
        position: absolute;
        top: 1rem;
        right: 1rem;
        left: 1rem;
        background: rgba(0,0,0,0.7);
        padding: 0.75rem;
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }
    
    @media (min-width: 768px) {
        .round-history {
            left: auto;
            max-width: 500px;
        }
    }
    
    .history-items {
        display: flex;
        gap: 0.4rem;
        overflow-x: auto;
        padding: 0.25rem 0;
    }
    
    .history-items::-webkit-scrollbar {
        height: 4px;
    }
    
    .history-item {
        min-width: 50px;
        padding: 0.4rem 0.5rem;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    
    @media (min-width: 768px) {
        .history-item {
            min-width: 55px;
            font-size: 0.85rem;
        }
    }
    
    .history-item.low { background-color: #d32f2f; }
    .history-item.medium { background-color: #f57c00; }
    .history-item.high { background-color: #388e3c; }
    
    /* Betting Panel */
    .betting-panel {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        border: 2px solid var(--border-color);
    }
    
    .amount-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: var(--dark-bg);
        border-radius: 8px;
        padding: 0.5rem;
    }
    
    .amount-btn {
        background-color: var(--hover-bg);
        border: none;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .amount-input {
        flex: 1;
        background: transparent;
        border: none;
        color: white;
        font-size: 1.25rem;
        text-align: center;
        font-weight: bold;
    }
    
    .amount-input:focus {
        outline: none;
    }
    
    .quick-amounts {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.4rem;
    }
    
    .quick-amount {
        background-color: var(--dark-bg);
        border: 1px solid var(--border-color);
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s;
        font-size: 0.85rem;
    }
    
    .quick-amount:hover {
        background-color: var(--hover-bg);
        border-color: var(--primary-color);
    }
    
    .bet-button {
        width: 100%;
        padding: 0.9rem;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .bet-button.place-bet {
        background: linear-gradient(135deg, var(--success-color), #66bb6a);
        color: white;
    }
    
    .bet-button.cashout {
        background: linear-gradient(135deg, var(--warning-color), #ffb74d);
        color: white;
        animation: pulse-btn 1s infinite;
    }
    
    @keyframes pulse-btn {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .bet-button:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        animation: none;
    }
    
    /* Active Bets */
    .active-bets {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        max-height: 250px;
        overflow-y: auto;
    }
    
    .active-bet-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem;
        background-color: var(--dark-bg);
        border-radius: 6px;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
    }
    
    /* Chat Section */
    .chat-section {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        height: 300px;
        display: flex;
        flex-direction: column;
    }
    
    @media (min-width: 768px) {
        .chat-section {
            height: 350px;
        }
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 0.75rem;
        padding-right: 0.5rem;
    }
    
    .chat-message {
        margin-bottom: 0.6rem;
        padding: 0.5rem;
        border-radius: 6px;
        background-color: var(--dark-bg);
        font-size: 0.85rem;
    }
    
    .chat-user {
        color: var(--primary-color);
        font-weight: bold;
        margin-right: 0.5rem;
    }
    
    /* Rain Alert */
    .rain-alert {
        position: fixed;
        top: 100px;
        right: 15px;
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
        z-index: 9998;
        max-width: 280px;
        animation: slideIn 0.5s;
    }
    
    .rain-icon {
        font-size: 2.5rem;
        text-align: center;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="game-container">
        <!-- Main Game Canvas -->
        <div>
            <div class="game-canvas" id="gameCanvas">
                <!-- Game Status -->
                <div class="game-status">
                    <div class="status-text" id="gameStatus">
                        <span class="status-waiting">WAITING...</span>
                    </div>
                    <small class="text-secondary">Round #<span id="currentRound">1</span></small>
                </div>
                
                <!-- Round History (Top Right) -->
                <div class="round-history">
                    <div class="history-items" id="historyItems">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Multiplier Display -->
                <div class="multiplier-display" id="multiplierDisplay">1.00x</div>
                
                <!-- Plane SVG -->
                <img src="{% static 'images/plane.svg' %}" class="plane-svg" id="planeIcon" alt="Plane">
            </div>
            
            <!-- Chat Section (Below Game on Mobile) -->
            <div class="chat-section mt-3">
                <h6 class="mb-2">
                    <i class="bi bi-chat-dots-fill"></i> Live Chat
                </h6>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="input-group input-group-sm">
                    <input type="text" id="chatInput" class="form-control form-control-sm" 
                           placeholder="Message..." maxlength="500">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div>
            <!-- Betting Panel -->
            <div class="betting-panel mb-3">
                <h6 class="mb-3">
                    <i class="bi bi-coin"></i> Place Bet
                </h6>
                
                <!-- Bet Amount -->
                <label class="form-label small text-secondary">Amount (KES)</label>
                <div class="amount-control mb-2">
                    <button class="amount-btn" onclick="decreaseAmount()">-</button>
                    <input type="number" id="betAmount" class="amount-input" value="50" min="10" max="50000">
                    <button class="amount-btn" onclick="increaseAmount()">+</button>
                </div>
                
                <!-- Quick Amounts -->
                <div class="quick-amounts mb-3">
                    <div class="quick-amount" onclick="setAmount(50)">50</div>
                    <div class="quick-amount" onclick="setAmount(100)">100</div>
                    <div class="quick-amount" onclick="setAmount(500)">500</div>
                    <div class="quick-amount" onclick="setAmount(1000)">1K</div>
                </div>
                
                <!-- Auto Cashout -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="autoCashoutEnabled">
                    <label class="form-check-label small" for="autoCashoutEnabled">
                        Auto cashout at
                        <input type="number" id="autoCashoutAmount" class="form-control form-control-sm d-inline-block" 
                               style="width: 70px;" value="2.00" min="1.01" step="0.01" disabled>x
                    </label>
                </div>
                
                <!-- Bet Button -->
                <button class="bet-button place-bet" id="betButton" onclick="placeBet()">
                    <i class="bi bi-check-circle-fill"></i> PLACE BET
                </button>
                
                <!-- Current Bet Info -->
                <div id="currentBetInfo" class="mt-3 p-2 bg-dark rounded" style="display: none; font-size: 0.85rem;">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Bet:</span>
                        <span id="activeBetAmount" class="text-success fw-bold">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Multiplier:</span>
                        <span id="activeBetMultiplier" class="text-warning fw-bold">1.00x</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Win:</span>
                        <span id="activeBetPotential" class="text-success fw-bold">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Active Bets -->
            <div class="active-bets">
                <h6 class="mb-2">
                    <i class="bi bi-people-fill"></i> Active Bets
                </h6>
                <div id="activeBetsList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Rain Alert -->
<div id="rainAlert" class="rain-alert" style="display: none;">
    <div class="rain-icon">üåßÔ∏èüí∞</div>
    <div class="text-center fw-bold mb-2">RAIN ACTIVE!</div>
    <div class="text-center small mb-2">
        <div><span id="rainAmount">0</span> KES per user</div>
        <div><span id="rainParticipants">0</span>/<span id="rainMaxParticipants">10</span> joined</div>
    </div>
    <button class="btn btn-light btn-sm w-100 fw-bold" onclick="joinRain()">JOIN NOW</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
        // Game State
        let gameState = {
            status: 'waiting',
            currentMultiplier: 1.00,
            currentRound: null,
            activeBet: null,
            roundHistory: []
        };
        
        let updateInterval = null;
        let planePosition = { x: 10, y: 90, angle: -45 };
        
        // Auto-cashout checkbox
        document.getElementById('autoCashoutEnabled').addEventListener('change', function() {
            document.getElementById('autoCashoutAmount').disabled = !this.checked;
        });
        
        // Bet Amount Controls
        window.decreaseAmount = function() {
            const input = document.getElementById('betAmount');
            let value = parseInt(input.value) || 50;
            input.value = Math.max(10, value - 10);
        };
        
        window.increaseAmount = function() {
            const input = document.getElementById('betAmount');
            let value = parseInt(input.value) || 50;
            input.value = Math.min(50000, value + 10);
        };
        
        window.setAmount = function(amount) {
            document.getElementById('betAmount').value = amount;
        };
        
        // Place Bet
        window.placeBet = async function() {
            const amount = document.getElementById('betAmount').value;
            const autoCashoutEnabled = document.getElementById('autoCashoutEnabled').checked;
            const autoCashout = autoCashoutEnabled ? document.getElementById('autoCashoutAmount').value : null;
            
            if (amount < 10) {
                showToast('Minimum bet is 10 KES', 'error');
                return;
            }
            
            const result = await apiCall('{% url "aviator:api_place_bet" %}', 'POST', {
                amount: amount,
                auto_cashout: autoCashout
            });
            
            if (result.success) {
                gameState.activeBet = result.bet;
                showToast('Bet placed!', 'success');
                updateBetButton();
                showCurrentBetInfo();
                await updateBalance();
            } else {
                showToast(result.message, 'error');
            }
        };
        
        // Cashout
        window.cashout = async function() {
            if (!gameState.activeBet) return;
            
            const result = await apiCall('{% url "aviator:api_cashout" %}', 'POST', {
                bet_id: gameState.activeBet.id,
                multiplier: gameState.currentMultiplier
            });
            
            if (result.success) {
                showToast(`Cashed out ${result.multiplier}x! Won ${result.payout} KES`, 'success');
                gameState.activeBet = null;
                updateBetButton();
                hideCurrentBetInfo();
                await updateBalance();
            } else {
                showToast(result.message, 'error');
            }
        };
        
        function updateBetButton() {
            const button = document.getElementById('betButton');
            
            if (gameState.activeBet && gameState.status === 'flying') {
                button.innerHTML = '<i class="bi bi-cash-stack"></i> CASHOUT';
                button.className = 'bet-button cashout';
                button.onclick = cashout;
                button.disabled = false;
            } else if (gameState.status === 'waiting') {
                button.innerHTML = '<i class="bi bi-check-circle-fill"></i> PLACE BET';
                button.className = 'bet-button place-bet';
                button.onclick = placeBet;
                button.disabled = gameState.activeBet !== null;
            } else {
                button.disabled = true;
            }
        }
        
        function showCurrentBetInfo() {
            document.getElementById('currentBetInfo').style.display = 'block';
            document.getElementById('activeBetAmount').textContent = formatCurrency(gameState.activeBet.amount) + ' KES';
            updatePotentialWin();
        }
        
        function hideCurrentBetInfo() {
            document.getElementById('currentBetInfo').style.display = 'none';
        }
        
        function updatePotentialWin() {
            if (!gameState.activeBet) return;
            const potential = gameState.activeBet.amount * gameState.currentMultiplier;
            document.getElementById('activeBetMultiplier').textContent = gameState.currentMultiplier.toFixed(2) + 'x';
            document.getElementById('activeBetPotential').textContent = formatCurrency(potential) + ' KES';
        }
        
        // Fetch current round
        async function fetchCurrentRound() {
            const result = await apiCall('{% url "aviator:api_current_round" %}');
            
            if (result.success && result.round) {
                const round = result.round;
                gameState.currentRound = round;
                gameState.status = round.status;
                gameState.currentMultiplier = round.multiplier || 1.00;
                
                updateGameDisplay();
                updateActiveBetsList(round.bets);
                
                if (gameState.activeBet && gameState.activeBet.auto_cashout && 
                    gameState.currentMultiplier >= gameState.activeBet.auto_cashout) {
                    await cashout();
                }
            }
        }
        
        function updateGameDisplay() {
            const statusElement = document.getElementById('gameStatus');
            const multiplierElement = document.getElementById('multiplierDisplay');
            const roundElement = document.getElementById('currentRound');
            
            if (gameState.currentRound) {
                roundElement.textContent = gameState.currentRound.round_number;
            }
            
            multiplierElement.textContent = gameState.currentMultiplier.toFixed(2) + 'x';
            
            if (gameState.status === 'waiting') {
                statusElement.innerHTML = '<span class="status-waiting">WAITING...</span>';
                multiplierElement.classList.remove('flying');
                resetPlane();
            } else if (gameState.status === 'flying') {
                statusElement.innerHTML = '<span class="status-flying">FLYING!</span>';
                multiplierElement.classList.add('flying');
                animatePlane();
            } else if (gameState.status === 'crashed') {
                statusElement.innerHTML = '<span class="status-crashed">FLEW AWAY!</span>';
                multiplierElement.classList.remove('flying');
            }
            
            updateBetButton();
            if (gameState.activeBet) updatePotentialWin();
        }
        
        function resetPlane() {
            planePosition = { x: 10, y: 90, angle: -45 };
            const planeElement = document.getElementById('planeIcon');
            planeElement.style.left = '10%';
            planeElement.style.bottom = '10%';
            planeElement.style.transform = 'rotate(-45deg)';
        }
        
        function animatePlane() {
            const planeElement = document.getElementById('planeIcon');
            const canvas = document.getElementById('gameCanvas');
            
            // Curved trajectory calculation
            const progress = Math.min((gameState.currentMultiplier - 1) / 10, 1);
            
            // Bezier curve for smooth flight path
            const startX = 10, startY = 10;
            const controlX = 40, controlY = 60;
            const endX = 85, endY = 85;
            
            const t = progress;
            const x = Math.pow(1-t, 2) * startX + 2 * (1-t) * t * controlX + Math.pow(t, 2) * endX;
            const y = Math.pow(1-t, 2) * startY + 2 * (1-t) * t * controlY + Math.pow(t, 2) * endY;
            
            // Calculate angle based on trajectory
            const angle = -45 + (progress * 30);
            
            planePosition = { x, y, angle };
            
            planeElement.style.left = x + '%';
            planeElement.style.bottom = y + '%';
            planeElement.style.transform = `rotate(${angle}deg)`;
        }
        
        // Fetch round history
        async function fetchRoundHistory() {
            const result = await apiCall('{% url "aviator:api_round_history" %}?limit=20');
            if (result.success) {
                gameState.roundHistory = result.history;
                displayRoundHistory();
            }
        }
        
        function displayRoundHistory() {
            const container = document.getElementById('historyItems');
            container.innerHTML = '';
            
            gameState.roundHistory.forEach(round => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                if (round.multiplier < 2) item.classList.add('low');
                else if (round.multiplier < 5) item.classList.add('medium');
                else item.classList.add('high');
                
                item.textContent = round.multiplier.toFixed(2) + 'x';
                container.appendChild(item);
            });
        }
        
        function updateActiveBetsList(bets) {
            const container = document.getElementById('activeBetsList');
            container.innerHTML = '';
            
            if (!bets || bets.length === 0) {
                container.innerHTML = '<small class="text-secondary">No active bets</small>';
                return;
            }
            
            bets.slice(0, 10).forEach(bet => {
                const item = document.createElement('div');
                item.className = 'active-bet-item';
                item.innerHTML = `
                    <div>
                        <div class="text-secondary small">${bet.user__phone_number}</div>
                        <div class="text-success fw-bold">${formatCurrency(bet.amount)}</div>
                    </div>
                    ${bet.cashout_multiplier ? 
                        `<div class="text-warning fw-bold">${bet.cashout_multiplier}x</div>` : ''}
                `;
                container.appendChild(item);
            });
        }
        
        // Chat functions
        async function loadChatMessages() {
            const result = await apiCall('{% url "aviator:api_chat_messages" %}?limit=30');
            if (result.success) {
                const container = document.getElementById('chatMessages');
                container.innerHTML = '';
                result.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-message';
                    div.innerHTML = `<span class="chat-user">${msg.user}:</span>${escapeHtml(msg.message)}`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            }
        }
        
        window.sendMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const result = await apiCall('{% url "aviator:api_send_message" %}', 'POST', { message });
            if (result.success) {
                input.value = '';
                await loadChatMessages();
            } else {
                showToast(result.message, 'error');
            }
        };
        
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Check rains
        async function checkActiveRains() {
            const result = await apiCall('{% url "aviator:api_active_rains" %}');
            if (result.success && result.rains.length > 0) {
                const rain = result.rains[0];
                if (!rain.has_joined && !rain.is_full) showRainAlert(rain);
            }
        }
        
        function showRainAlert(rain) {
            const alert = document.getElementById('rainAlert');
            document.getElementById('rainAmount').textContent = rain.amount_per_user;
            document.getElementById('rainParticipants').textContent = rain.participants_count;
            document.getElementById('rainMaxParticipants').textContent = rain.max_participants;
            alert.style.display = 'block';
            alert.dataset.rainId = rain.id;
        }
        
        window.joinRain = async function() {
            const alert = document.getElementById('rainAlert');
            const result = await apiCall('{% url "aviator:api_join_rain" %}', 'POST', {
                rain_id: alert.dataset.rainId
            });
            if (result.success) {
                showToast('Joined rain!', 'success');
                alert.style.display = 'none';
                await updateBalance();
            } else {
                showToast(result.message, 'error');
            }
        };
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize
        async function initGame() {
            await fetchRoundHistory();
            await loadChatMessages();
            await checkActiveRains();
            
            updateInterval = setInterval(fetchCurrentRound, 100);
            setInterval(loadChatMessages, 5000);
            setInterval(checkActiveRains, 10000);
        }
        
        // Start
        initGame();
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
        });
    });
</script>
{% endblock %}